
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analysis - {{signal.coin_name}}</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .navbar { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
        .content-panel { 
            background: rgba(255,255,255,0.95); border-radius: 15px; 
            padding: 15px; margin-bottom: 15px; backdrop-filter: blur(10px); 
        }
        .chart-container { 
            border-radius: 15px; overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        .btn-timeframe { 
            margin: 2px; border-radius: 20px; font-size: 0.85rem;
            min-width: 50px;
        }
        .btn-timeframe.active { 
            background: linear-gradient(45deg, #ff6b6b 0%, #4ecdc4 100%); 
            border: none; color: white; font-weight: bold;
        }
        .trade-info { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: white; border-radius: 15px; padding: 15px; 
        }
        .control-btn { 
            border-radius: 25px; margin: 3px; font-size: 0.85rem;
            padding: 8px 16px;
        }
        .status-panel { 
            background: rgba(255,255,255,0.9); border-radius: 10px; 
            padding: 10px; 
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">üöÄ Advanced TradingView Analyzer</a>
            <span class="navbar-text">{{signal.coin_name}} ‚Ä¢ Signal Time: {{signal.timestamp}}</span>
        </div>
    </nav>
    
    <div class="container-fluid mt-2">
        <!-- Advanced Control Panel -->
        <div class="content-panel">
            <div class="row">
                <div class="col-md-6">
                    <h6>‚öôÔ∏è Trading Parameters</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Stop Loss %</label>
                            <input type="number" class="form-control" id="stopLoss" value="10" step="0.5" min="1" max="50">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Risk:Reward</label>
                            <input type="number" class="form-control" id="riskReward" value="1.5" step="0.1" min="0.5" max="10">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Days After</label>
                            <input type="number" class="form-control" id="daysAfter" value="30" min="7" max="90">
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>‚è∞ Timeframes & Controls</h6>
                    <div class="mb-2">
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeAdvancedTimeframe('1')">1m</button>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeAdvancedTimeframe('5')">5m</button>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeAdvancedTimeframe('15')">15m</button>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeAdvancedTimeframe('60')">1h</button>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeAdvancedTimeframe('240')">4h</button>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeAdvancedTimeframe('1D')">1D</button>
                    </div>
                    <div>
                        <button class="btn btn-success control-btn" onclick="updateAdvancedChart()">üîÑ Refresh</button>
                        <button class="btn btn-primary control-btn" onclick="jumpToSignalAdvanced()">üìç Jump to Signal</button>
                        <button class="btn btn-warning control-btn" onclick="addTradeLevelsAdvanced()">üìè Add Levels</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trade Information -->
        <div class="trade-info mb-2">
            <div class="row text-center">
                <div class="col-md-2">
                    <strong>üí∞ Entry:</strong><br>$<span id="entryPrice">{{signal.entry_price}}</span>
                </div>
                <div class="col-md-2">
                    <strong>üõë Stop Loss:</strong><br>$<span id="stopLossPrice">-</span>
                </div>
                <div class="col-md-2">
                    <strong>üéØ Take Profit:</strong><br>$<span id="takeProfitPrice">-</span>
                </div>
                <div class="col-md-3">
                    <strong>üìÖ Signal Time:</strong><br>{{signal.timestamp}}
                </div>
                <div class="col-md-3">
                    <strong>üìä Symbol:</strong><br>{{signal.symbol}}
                </div>
            </div>
        </div>
        
        <!-- Advanced Chart Container -->
        <div class="chart-container">
            <div id="advanced_chart_container" style="height: 650px; width: 100%;"></div>
        </div>
        
        <!-- Status and Analysis -->
        <div class="content-panel mt-2">
            <div class="row">
                <div class="col-md-8">
                    <div class="status-panel">
                        <h6>üìä Chart Status & Analysis</h6>
                        <p><strong>Status:</strong> <span id="chartStatus">Initializing...</span></p>
                        <p><strong>Current Timeframe:</strong> <span id="currentTimeframe">1h</span></p>
                        <p><strong>Signal Unix Time:</strong> {{signal.unix_timestamp}}</p>
                        <div id="tradeAnalysis" style="display: none;">
                            <h6>üìà Trade Analysis</h6>
                            <div id="analysisContent"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="status-panel">
                        <h6>üéõÔ∏è Quick Actions</h6>
                        <button class="btn btn-info control-btn w-100 mb-2" onclick="showTradeAnalysis()">üìä Analyze Trade</button>
                        <button class="btn btn-secondary control-btn w-100 mb-2" onclick="resetChart()">üîÑ Reset Chart</button>
                        <button class="btn btn-primary control-btn w-100" onclick="exportChart()">üíæ Export View</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let advancedWidget;
        let currentSymbol = '{{signal.symbol}}';
        let currentTimeframe = '60';
        let tradeIndex = {{trade_index}};
        let signalUnixTime = {{signal.unix_timestamp}};
        let entryPrice = {{signal.entry_price}};
        let tradeData = null;
        let chartReady = false;
        
        // Initialize advanced TradingView widget
        function initAdvancedChart() {
            const container = document.getElementById('advanced_chart_container');
            container.innerHTML = '';
            
            console.log('Initializing chart for', currentSymbol, 'at time', signalUnixTime);
            document.getElementById('chartStatus').textContent = 'Loading chart...';
            
            // Calculate time range based on timeframe
            let daysAfter = parseInt(document.getElementById('daysAfter').value) || 30;
            let daysBefore = 7;
            
            if (currentTimeframe === '1') {
                daysBefore = 1;
                daysAfter = 7;
            } else if (currentTimeframe === '5') {
                daysBefore = 3;
                daysAfter = 14;
            } else if (currentTimeframe === '240' || currentTimeframe === '1D') {
                daysBefore = 30;
                daysAfter = 90;
            }
            
            const startTime = signalUnixTime - (daysBefore * 24 * 3600);
            const endTime = signalUnixTime + (daysAfter * 24 * 3600);
            
            try {
                advancedWidget = new TradingView.widget({
                    "autosize": true,
                    "symbol": "BINANCE:" + currentSymbol,
                    "interval": currentTimeframe,
                    "timezone": "Etc/UTC",
                    "theme": "light",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "container_id": "advanced_chart_container",
                    "height": 650,
                    "studies": [
                        "Volume@tv-basicstudies",
                        "RSI@tv-basicstudies"
                    ],
                    // Advanced settings for Premium users
                    "overrides": {
                        "mainSeriesProperties.candleStyle.upColor": "#4ECDC4",
                        "mainSeriesProperties.candleStyle.downColor": "#FF6B6B",
                        "mainSeriesProperties.candleStyle.borderUpColor": "#4ECDC4",
                        "mainSeriesProperties.candleStyle.borderDownColor": "#FF6B6B"
                    },
                    "studies_overrides": {
                        "volume.volume.color.0": "#FF6B6B",
                        "volume.volume.color.1": "#4ECDC4"
                    },
                    "disabled_features": [
                        "use_localstorage_for_settings",
                        "save_chart_properties_to_local_storage"
                    ],
                    "enabled_features": [
                        "study_templates",
                        "side_toolbar_in_fullscreen_mode"
                    ],
                    // Set initial time range
                    "time_frames": [],
                    "charts_storage_url": "",
                    "charts_storage_api_version": "1.1",
                    "client_id": "",
                    "user_id": ""
                });
                
                // Setup chart ready callback
                advancedWidget.onChartReady(function() {
                    console.log('Advanced chart ready');
                    chartReady = true;
                    document.getElementById('chartStatus').textContent = 'Chart loaded successfully';
                    
                    // Load trade data and setup visualization
                    loadTradeDataAdvanced();
                    
                    // Set time range after a short delay
                    setTimeout(() => {
                        jumpToSignalAdvanced();
                    }, 1000);
                });
                
            } catch (error) {
                console.error('Error initializing chart:', error);
                document.getElementById('chartStatus').textContent = 'Error loading chart: ' + error.message;
            }
        }
        
        // Load trade data for advanced analysis
        function loadTradeDataAdvanced() {
            const params = new URLSearchParams({
                stop_loss: document.getElementById('stopLoss').value,
                risk_reward: document.getElementById('riskReward').value,
                days_ahead: document.getElementById('daysAfter').value
            });
            
            fetch(`/api/trade_data/${tradeIndex}?${params}`)
                .then(response => response.json())
                .then(data => {
                    tradeData = data;
                    console.log('Trade data loaded:', data);
                    updateAdvancedLevels();
                })
                .catch(error => {
                    console.error('Error loading trade data:', error);
                    document.getElementById('chartStatus').textContent = 'Error loading trade data';
                });
        }
        
        // Jump to signal time with advanced precision
        function jumpToSignalAdvanced() {
            if (!advancedWidget || !chartReady) {
                console.log('Chart not ready for time navigation');
                document.getElementById('chartStatus').textContent = 'Chart not ready for navigation';
                return;
            }
            
            try {
                // Use activeChart() method as per TradingView docs
                const chart = advancedWidget.activeChart();
                
                if (!chart) {
                    console.error('No active chart available');
                    document.getElementById('chartStatus').textContent = 'No active chart available';
                    return;
                }
                
                const daysAfter = parseInt(document.getElementById('daysAfter').value) || 30;
                
                // Calculate precise time range - TradingView uses Unix timestamps
                const startTime = signalUnixTime - (7 * 24 * 3600);
                const endTime = signalUnixTime + (daysAfter * 24 * 3600);
                
                console.log('Setting visible range:', {
                    from: startTime,
                    to: endTime,
                    signalTime: signalUnixTime,
                    signalDate: new Date(signalUnixTime * 1000),
                    startDate: new Date(startTime * 1000),
                    endDate: new Date(endTime * 1000)
                });
                
                // Use the proper setVisibleRange API as documented
                chart.setVisibleRange(
                    {
                        from: startTime,
                        to: endTime
                    },
                    {
                        // Add options as per documentation
                        percentRightMargin: 20  // 20% margin on the right
                    }
                ).then(() => {
                    console.log('Visible range set successfully');
                    document.getElementById('chartStatus').textContent = 
                        `‚úÖ Jumped to signal time: ${new Date(signalUnixTime * 1000).toLocaleString()}`;
                    
                    // Add trade levels after successful navigation
                    setTimeout(() => {
                        addTradeLevelsAdvanced();
                    }, 1000);
                    
                }).catch((error) => {
                    console.error('Failed to set visible range:', error);
                    document.getElementById('chartStatus').textContent = 
                        `‚ùå Navigation failed: ${error.message || 'Unknown error'}`;
                    
                    // Try alternative method
                    tryAlternativeNavigation();
                });
                
            } catch (error) {
                console.error('Error in jumpToSignalAdvanced:', error);
                document.getElementById('chartStatus').textContent = 'Error navigating to signal time: ' + error.message;
                
                // Try alternative navigation
                tryAlternativeNavigation();
            }
        }
        
        // Alternative navigation method when primary fails
        function tryAlternativeNavigation() {
            try {
                console.log('Trying alternative navigation method...');
                const chart = advancedWidget.activeChart();
                
                if (!chart) return;
                
                // Method 1: Try simpler setVisibleRange without options
                chart.setVisibleRange({
                    from: signalUnixTime - (14 * 24 * 3600),
                    to: signalUnixTime + (30 * 24 * 3600)
                }).then(() => {
                    document.getElementById('chartStatus').textContent = 
                        `üìç Navigated to signal time (alternative method)`;
                    setTimeout(() => addTradeLevelsAdvanced(), 500);
                }).catch(() => {
                    // Final fallback - just show the info
                    document.getElementById('chartStatus').textContent = 
                        `‚ö†Ô∏è Chart navigation limited. Signal time: ${new Date(signalUnixTime * 1000).toLocaleString()}`;
                    addTradeLevelsAdvanced();
                });
                
            } catch (error) {
                console.error('Alternative navigation failed:', error);
                document.getElementById('chartStatus').textContent = 
                    `‚ùå All navigation methods failed. Signal time: ${new Date(signalUnixTime * 1000).toLocaleString()}`;
                addTradeLevelsAdvanced();
            }
        }
        
        // Add trade levels with advanced features
        function addTradeLevelsAdvanced() {
            if (!advancedWidget || !chartReady || !tradeData) {
                console.log('Cannot add levels - chart not ready or no trade data');
                return;
            }
            
            try {
                const chart = advancedWidget.chart();
                
                // Remove existing shapes first
                chart.removeAllShapes();
                
                // Add Entry Level
                chart.createShape(
                    { time: signalUnixTime, price: tradeData.entry_price },
                    {
                        shape: 'horizontal_line',
                        text: `ENTRY $${tradeData.entry_price.toFixed(4)}`,
                        overrides: {
                            linecolor: '#2196F3',
                            linewidth: 3,
                            linestyle: 0
                        }
                    }
                );
                
                // Add Stop Loss Level
                chart.createShape(
                    { time: signalUnixTime, price: tradeData.stop_loss_price },
                    {
                        shape: 'horizontal_line',
                        text: `STOP LOSS $${tradeData.stop_loss_price.toFixed(4)} (-${tradeData.stop_loss_pct}%)`,
                        overrides: {
                            linecolor: '#F44336',
                            linewidth: 2,
                            linestyle: 2
                        }
                    }
                );
                
                // Add Take Profit Level
                chart.createShape(
                    { time: signalUnixTime, price: tradeData.take_profit_price },
                    {
                        shape: 'horizontal_line',
                        text: `TAKE PROFIT $${tradeData.take_profit_price.toFixed(4)} (+${(tradeData.stop_loss_pct * tradeData.risk_reward_ratio).toFixed(1)}%)`,
                        overrides: {
                            linecolor: '#4CAF50',
                            linewidth: 2,
                            linestyle: 2
                        }
                    }
                );
                
                // Add Signal Marker
                chart.createShape(
                    { time: signalUnixTime, price: tradeData.entry_price },
                    {
                        shape: 'arrow_up',
                        text: `BUY SIGNAL\n${tradeData.signal_time}`,
                        overrides: {
                            color: '#4CAF50',
                            textcolor: '#FFFFFF'
                        }
                    }
                );
                
                document.getElementById('chartStatus').textContent = 'Trade levels added successfully';
                
            } catch (error) {
                console.error('Error adding trade levels:', error);
                document.getElementById('chartStatus').textContent = 'Error adding trade levels: ' + error.message;
            }
        }
        
        // Change timeframe with advanced handling
        function changeAdvancedTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // Update timeframe display
            const timeframeText = {
                '1': '1m', '5': '5m', '15': '15m', 
                '60': '1h', '240': '4h', '1D': '1D'
            }[timeframe] || timeframe;
            
            document.getElementById('currentTimeframe').textContent = timeframeText;
            
            // Update active button
            document.querySelectorAll('.btn-timeframe').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Reinitialize chart with new timeframe
            chartReady = false;
            initAdvancedChart();
        }
        
        // Update chart with new parameters
        function updateAdvancedChart() {
            updateAdvancedLevels();
            loadTradeDataAdvanced();
        }
        
        // Update levels display
        function updateAdvancedLevels() {
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const riskReward = parseFloat(document.getElementById('riskReward').value);
            
            const stopLossPrice = entryPrice * (1 - stopLoss / 100);
            const takeProfitPrice = entryPrice * (1 + (stopLoss * riskReward) / 100);
            
            document.getElementById('stopLossPrice').textContent = stopLossPrice.toFixed(4);
            document.getElementById('takeProfitPrice').textContent = takeProfitPrice.toFixed(4);
        }
        
        // Show trade analysis
        function showTradeAnalysis() {
            document.getElementById('tradeAnalysis').style.display = 'block';
            document.getElementById('analysisContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Signal Time:</strong> ${new Date(signalUnixTime * 1000).toLocaleString()}</p>
                        <p><strong>Entry Price:</strong> $${entryPrice.toFixed(4)}</p>
                        <p><strong>Risk:Reward:</strong> 1:${document.getElementById('riskReward').value}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Stop Loss:</strong> ${document.getElementById('stopLoss').value}%</p>
                        <p><strong>Symbol:</strong> ${currentSymbol}</p>
                        <p><strong>Timeframe:</strong> ${document.getElementById('currentTimeframe').textContent}</p>
                    </div>
                </div>
            `;
        }
        
        // Reset chart
        function resetChart() {
            chartReady = false;
            initAdvancedChart();
        }
        
        // Export chart (placeholder)
        function exportChart() {
            alert('Chart export feature - integrate with TradingView export API');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateAdvancedLevels();
            initAdvancedChart();
            
            // Set initial active timeframe
            document.querySelector('[onclick="changeAdvancedTimeframe(\'60\')"]').classList.add('active');
        });
    </script>
</body>
</html>
        