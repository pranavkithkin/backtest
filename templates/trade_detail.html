
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Analysis - {{signal.coin_name}}</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .control-panel { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn-timeframe { margin: 2px; }
        .trade-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 10px; padding: 15px; }
        .alert-outcome { margin-top: 15px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">📊 TradingView Trade Analyzer</a>
            <span class="navbar-text">{{signal.coin_name}} Analysis</span>
        </div>
    </nav>
    
    <div class="container-fluid mt-4">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="row">
                <div class="col-md-8">
                    <h5>⚙️ Trading Parameters</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Stop Loss %</label>
                            <input type="number" class="form-control" id="stopLoss" value="10" step="0.5" min="1" max="50">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Risk:Reward</label>
                            <input type="number" class="form-control" id="riskReward" value="1.5" step="0.1" min="0.5" max="10">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Days to Analyze</label>
                            <input type="number" class="form-control" id="daysAhead" value="30" min="7" max="90">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-success form-control" onclick="updateChart()">📊 Update Chart</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>⏰ Chart Timeframe</h5>
                    <div>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeTimeframe('5')">5m</button>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeTimeframe('15')">15m</button>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeTimeframe('60')">1h</button>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeTimeframe('240')">4h</button>
                        <button class="btn btn-outline-primary btn-timeframe" onclick="changeTimeframe('1D')">1D</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trade Info -->
        <div class="trade-info mb-3">
            <div class="row">
                <div class="col-md-2">
                    <strong>💰 Entry Price:</strong><br>
                    $<span id="entryPrice">{{signal.entry_price}}</span>
                </div>
                <div class="col-md-2">
                    <strong>🛑 Stop Loss:</strong><br>
                    $<span id="stopLossPrice">-</span> (<span id="stopLossPct">-</span>%)
                </div>
                <div class="col-md-2">
                    <strong>🎯 Take Profit:</strong><br>
                    $<span id="takeProfitPrice">-</span> (<span id="takeProfitPct">-</span>%)
                </div>
                <div class="col-md-3">
                    <strong>📅 Signal Time:</strong><br>
                    {{signal.timestamp}}
                </div>
                <div class="col-md-3">
                    <strong>📊 Symbol:</strong><br>
                    {{signal.symbol}} ({{signal.coin_name}})
                </div>
            </div>
        </div>
        
        <!-- Trade Outcome Alert -->
        <div id="tradeOutcome" class="alert-outcome"></div>
        
        <!-- TradingView Chart with Advanced Features -->
        <div class="chart-container">
            <div id="tradingview_chart" style="height: 700px;"></div>
        </div>
        
        <!-- Chart Controls -->
        <div class="mt-3">
            <div class="card">
                <div class="card-header">
                    <h5>🎛️ Chart Controls & Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-primary me-2" onclick="jumpToSignalTime()">📍 Jump to Signal Time</button>
                            <button class="btn btn-warning me-2" onclick="toggleLevels()">📏 Toggle SL/TP Lines</button>
                            <button class="btn btn-info me-2" onclick="showTradeOutcome()">🎯 Show Trade Outcome</button>
                        </div>
                        <div class="col-md-6">
                            <div id="chartAnalysis">
                                <p><strong>Chart Status:</strong> <span id="chartStatus">Loading...</span></p>
                                <p><strong>Current Timeframe:</strong> <span id="currentTimeframe">1h</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let widget;
        let currentSymbol = '{{signal.symbol}}'.replace('USDT', '');
        let currentTimeframe = '60';
        let tradeIndex = {{trade_index}};
        let signalTimestamp = new Date('{{signal.timestamp}}').getTime() / 1000; // Unix timestamp
        let entryPrice = {{signal.entry_price}};
        let showLevels = true;
        
        // Initialize enhanced TradingView widget
        function initChart() {
            const container = document.getElementById('tradingview_chart');
            container.innerHTML = ''; // Clear previous widget
            
            // Calculate time range around signal
            const daysAhead = parseInt(document.getElementById('daysAhead').value) || 30;
            const signalDate = new Date('{{signal.timestamp}}');
            const startDate = new Date(signalDate.getTime() - (7 * 24 * 60 * 60 * 1000)); // 7 days before
            const endDate = new Date(signalDate.getTime() + (daysAhead * 24 * 60 * 60 * 1000)); // N days after
            
            widget = new TradingView.widget({
                "width": "100%",
                "height": 700,
                "symbol": "BINANCE:" + currentSymbol + "USDT",
                "interval": currentTimeframe,
                "timezone": "Etc/UTC",
                "theme": "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": false,
                "container_id": "tradingview_chart",
                "studies": [
                    "Volume@tv-basicstudies",
                    "RSI@tv-basicstudies"
                ],
                "show_popup_button": true,
                "popup_width": "1200",
                "popup_height": "800",
                "range": "ytd", // Will be overridden
                "hide_side_toolbar": false,
                "details": true,
                "hotlist": true,
                "calendar": true,
                // Advanced features for Premium
                "studies_overrides": {
                    "volume.volume.color.0": "#FF6B6B",
                    "volume.volume.color.1": "#4ECDC4"
                },
                "overrides": {
                    "mainSeriesProperties.candleStyle.upColor": "#4ECDC4",
                    "mainSeriesProperties.candleStyle.downColor": "#FF6B6B",
                    "mainSeriesProperties.candleStyle.borderUpColor": "#4ECDC4",
                    "mainSeriesProperties.candleStyle.borderDownColor": "#FF6B6B"
                },
                "disabled_features": [],
                "enabled_features": [
                    "side_toolbar_in_fullscreen_mode",
                    "header_in_fullscreen_mode",
                    "timeframes_toolbar"
                ]
            });
            
            // When widget is ready, add custom elements
            widget.onChartReady(function() {
                console.log('Chart is ready');
                document.getElementById('chartStatus').textContent = 'Ready';
                
                // Set up the chart with signal time and levels
                setupTradeVisualization();
            });
        }
        
        // Setup trade visualization with signal markers and levels
        function setupTradeVisualization() {
            if (!widget || !widget.chart) return;
            
            try {
                // Jump to signal time first
                jumpToSignalTime();
                
                // Add trade levels and markers
                setTimeout(() => {
                    addTradeLevels();
                    addSignalMarker();
                    showTradeOutcome();
                }, 1000);
                
            } catch (error) {
                console.error('Error setting up trade visualization:', error);
            }
        }
        
        // Jump chart to signal timestamp
        function jumpToSignalTime() {
            if (!widget || !widget.chart) return;
            
            try {
                const daysAhead = parseInt(document.getElementById('daysAhead').value) || 30;
                const signalDate = new Date('{{signal.timestamp}}');
                const startTime = Math.floor((signalDate.getTime() - (7 * 24 * 60 * 60 * 1000)) / 1000);
                const endTime = Math.floor((signalDate.getTime() + (daysAhead * 24 * 60 * 60 * 1000)) / 1000);
                
                // Set visible range
                widget.chart().setVisibleRange({
                    from: startTime,
                    to: endTime
                });
                
                document.getElementById('chartStatus').textContent = 'Jumped to signal time';
                
            } catch (error) {
                console.error('Error jumping to signal time:', error);
                document.getElementById('chartStatus').textContent = 'Error jumping to time';
            }
        }
        
        // Add horizontal lines for SL and TP
        function addTradeLevels() {
            if (!widget || !widget.chart || !showLevels) return;
            
            try {
                const stopLoss = parseFloat(document.getElementById('stopLoss').value);
                const riskReward = parseFloat(document.getElementById('riskReward').value);
                
                const stopLossPrice = entryPrice * (1 - stopLoss / 100);
                const takeProfitPrice = entryPrice * (1 + (stopLoss * riskReward) / 100);
                
                // Add horizontal lines using TradingView API
                widget.chart().createShape({
                    time: signalTimestamp,
                    price: entryPrice
                }, {
                    shape: 'horizontal_line',
                    text: `Entry: $${entryPrice.toFixed(4)}`,
                    overrides: {
                        linecolor: '#2196F3',
                        linewidth: 2,
                        linestyle: 0
                    }
                });
                
                widget.chart().createShape({
                    time: signalTimestamp,
                    price: stopLossPrice
                }, {
                    shape: 'horizontal_line',
                    text: `Stop Loss: $${stopLossPrice.toFixed(4)} (-${stopLoss}%)`,
                    overrides: {
                        linecolor: '#F44336',
                        linewidth: 2,
                        linestyle: 2
                    }
                });
                
                widget.chart().createShape({
                    time: signalTimestamp,
                    price: takeProfitPrice
                }, {
                    shape: 'horizontal_line',
                    text: `Take Profit: $${takeProfitPrice.toFixed(4)} (+${(stopLoss * riskReward).toFixed(1)}%)`,
                    overrides: {
                        linecolor: '#4CAF50',
                        linewidth: 2,
                        linestyle: 2
                    }
                });
                
                document.getElementById('chartStatus').textContent = 'Trade levels added';
                
            } catch (error) {
                console.error('Error adding trade levels:', error);
                document.getElementById('chartStatus').textContent = 'Error adding levels';
            }
        }
        
        // Add signal marker at entry point
        function addSignalMarker() {
            if (!widget || !widget.chart) return;
            
            try {
                widget.chart().createShape({
                    time: signalTimestamp,
                    price: entryPrice
                }, {
                    shape: 'arrow_up',
                    text: `BUY SIGNAL\n${new Date('{{signal.timestamp}}').toLocaleString()}\n$${entryPrice.toFixed(4)}`,
                    overrides: {
                        color: '#4CAF50',
                        textcolor: '#FFFFFF',
                        fontsize: 12
                    }
                });
                
                document.getElementById('chartStatus').textContent = 'Signal marker added';
                
            } catch (error) {
                console.error('Error adding signal marker:', error);
            }
        }
        
        // Toggle SL/TP levels visibility
        function toggleLevels() {
            showLevels = !showLevels;
            
            if (showLevels) {
                addTradeLevels();
                document.querySelector('[onclick="toggleLevels()"]').textContent = '📏 Hide SL/TP Lines';
            } else {
                // Remove all shapes (simplified approach - recreate chart)
                initChart();
                document.querySelector('[onclick="toggleLevels()"]').textContent = '📏 Show SL/TP Lines';
            }
        }
        
        // Show trade outcome analysis
        function showTradeOutcome() {
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const riskReward = parseFloat(document.getElementById('riskReward').value);
            
            fetch(`/api/trade_data/${tradeIndex}?stop_loss=${stopLoss}&risk_reward=${riskReward}`)
                .then(response => response.json())
                .then(data => {
                    // Simulate trade outcome analysis (you can enhance this with real data)
                    const outcome = analyzeTradeOutcome(data);
                    displayTradeOutcome(outcome);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('tradeOutcome').innerHTML = 
                        '<div class="alert alert-danger">Error loading trade outcome analysis</div>';
                });
        }
        
        // Analyze trade outcome (placeholder - enhance with real analysis)
        function analyzeTradeOutcome(data) {
            // This is a simplified analysis - you can enhance with real historical data
            const random = Math.random();
            
            if (random > 0.7) {
                return {
                    outcome: 'PROFIT',
                    hours: (Math.random() * 48 + 2).toFixed(1),
                    percentage: (data.stop_loss_pct * data.risk_reward_ratio).toFixed(1)
                };
            } else if (random > 0.3) {
                return {
                    outcome: 'LOSS',
                    hours: (Math.random() * 24 + 1).toFixed(1),
                    percentage: data.stop_loss_pct.toFixed(1)
                };
            } else {
                return {
                    outcome: 'NEITHER',
                    hours: (Math.random() * 168 + 24).toFixed(1),
                    percentage: 0
                };
            }
        }
        
        // Display trade outcome
        function displayTradeOutcome(outcome) {
            let alertClass, icon, message;
            
            switch(outcome.outcome) {
                case 'PROFIT':
                    alertClass = 'alert-success';
                    icon = '🎉';
                    message = `Take Profit hit after ${outcome.hours} hours (+${outcome.percentage}%)`;
                    break;
                case 'LOSS':
                    alertClass = 'alert-danger';
                    icon = '🛑';
                    message = `Stop Loss hit after ${outcome.hours} hours (-${outcome.percentage}%)`;
                    break;
                default:
                    alertClass = 'alert-warning';
                    icon = '⏳';
                    message = `Neither SL nor TP hit within ${outcome.hours} hours`;
            }
            
            document.getElementById('tradeOutcome').innerHTML = 
                `<div class="alert ${alertClass}">
                    <strong>${icon} Trade Outcome:</strong> ${message}
                 </div>`;
        }
        
        // Change timeframe
        function changeTimeframe(timeframe) {
            currentTimeframe = timeframe;
            document.getElementById('currentTimeframe').textContent = 
                timeframe === '5' ? '5m' : 
                timeframe === '15' ? '15m' : 
                timeframe === '60' ? '1h' : 
                timeframe === '240' ? '4h' : '1D';
            
            // Update active button
            document.querySelectorAll('.btn-timeframe').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Recreate widget with new timeframe
            initChart();
        }
        
        // Update chart with new parameters
        function updateChart() {
            updateLevels();
            initChart();
        }
        
        // Update trade levels display
        function updateLevels() {
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const riskReward = parseFloat(document.getElementById('riskReward').value);
            
            const stopLossPrice = entryPrice * (1 - stopLoss / 100);
            const takeProfitPrice = entryPrice * (1 + (stopLoss * riskReward) / 100);
            const takeProfitPct = stopLoss * riskReward;
            
            // Update display
            document.getElementById('stopLossPrice').textContent = stopLossPrice.toFixed(4);
            document.getElementById('stopLossPct').textContent = stopLoss.toFixed(1);
            document.getElementById('takeProfitPrice').textContent = takeProfitPrice.toFixed(4);
            document.getElementById('takeProfitPct').textContent = takeProfitPct.toFixed(1);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateLevels();
            initChart();
            
            // Set initial active timeframe
            document.querySelector('[onclick="changeTimeframe(\'60\')"]').classList.add('active');
        });
    </script>
</body>
</html>
        